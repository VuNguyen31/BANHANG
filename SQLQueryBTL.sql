CREATE DATABASE QL_BANHANG
USE QL_BANHANG

--TAO BANG NHA CUNG CAP
CREATE TABLE NHACUNGCAP
(MANCC INT PRIMARY KEY,
TEN VARCHAR(300) NOT NULL,
DIACHI TEXT,
SODIENTHOAI VARCHAR(20),
EMAIL VARCHAR(300))

SELECT * FROM NHACUNGCAP

--TAO BANG SAN PHAM
CREATE TABLE SANPHAM 
(MASP INT PRIMARY KEY,
MANCC INT FOREIGN KEY REFERENCES NHACUNGCAP(MANCC),
TENSP VARCHAR(250) NOT NULL,
GIA DECIMAL(10,2) NOT NULL,
MOTA TEXT )
SELECT * FROM SANPHAM 

--TAO BANG KHO
CREATE TABLE KHO
(MAKHO INT PRIMARY KEY,
TENKHO VARCHAR(300),
MASP INT FOREIGN KEY REFERENCES SANPHAM(MASP))

SELECT * FROM KHO

--TAO BANG NHAP KHO
CREATE TABLE NHAPKHO
(MANHAPKHO INT PRIMARY KEY,
MAKHO INT FOREIGN KEY REFERENCES KHO(MAKHO),
SOLUONG INT NOT NULL,
NGAYNHAP DATE NOT NULL)

SELECT * FROM NHAPKHO

--TAP BANG TON KHO 
CREATE TABLE TONKHO 
(MATONKHO INT PRIMARY KEY,
MAKHO INT FOREIGN KEY REFERENCES KHO(MAKHO),
SOLUONG INT NOT NULL)

SELECT * FROM TONKHO


--TAO BANG KHACH HANG 
CREATE TABLE KHACHHANG
(MAKH INT PRIMARY KEY,
HOTEN VARCHAR(300)NOT NULL,
DIACHI TEXT,
SODT VARCHAR(20),
EMAIL VARCHAR(300))

SELECT * FROM KHACHHANG

--TAO BANG KHUYEN MAI
CREATE TABLE KHUYENMAI
(MAKHUYENMAI CHAR(10) PRIMARY KEY,
TENKHUYENMAI VARCHAR(300) NOT NULL,
PHANTRAMGIAMGIA DECIMAL(5,2) NOT NULL,
NGAYBATDAU DATE NOT NULL,
NGAYKETTHUC DATE NOT NULL,
MOTA TEXT)

SELECT * FROM KHUYENMAI

--TAO BANG DON HANG
CREATE TABLE DONHANG
(MADH INT PRIMARY KEY,
MAKH INT FOREIGN KEY REFERENCES KHACHHANG(MAKH),
NGAYDATHANG DATE NOT NULL,
TONGTIEN DECIMAL(10,2) NOT NULL,
MAKHUYENMAI CHAR(10) FOREIGN KEY REFERENCES KHUYENMAI(MAKHUYENMAI))

SELECT * FROM DONHANG

--TAO BANG CHI TIET DON HANG
CREATE TABLE CHITIETDONHANG
(MACT INT PRIMARY KEY,
MADH INT FOREIGN KEY REFERENCES DONHANG(MADH),
MASP INT FOREIGN KEY REFERENCES SANPHAM(MASP),
MAKHUYENMAI CHAR(10) FOREIGN KEY REFERENCES KHUYENMAI(MAKHUYENMAI),
SOLUONG INT NOT NULL,
GIA DECIMAL(10,2) NOT NULL)

SELECT * FROM CHITIETDONHANG

--TAO BANG NHAN VIEN
CREATE TABLE NHANVIEN
(MANV INT PRIMARY KEY,
HOTEN VARCHAR(300) NOT NULL,
CHUCVU VARCHAR(300),
NGAYVAOLAM DATE,
SODT VARCHAR(20),
EMAIL VARCHAR(300))

SELECT * FROM NHANVIEN

-- Thêm dữ liệu mẫu vào bảng NHACUNGCAP (Nhà cung cấp)
INSERT INTO NHACUNGCAP (MANCC, TEN, DIACHI, SODIENTHOAI, EMAIL)
VALUES 
(2, 'Nhà cung cấp B', '456 Đường XYZ, Thành phố', '0123987654', 'nhacungcapb@example.com'),
(3, 'Nhà cung cấp C', '789 Đường LMN, Thành phố', '0111222333', 'nhacungcapc@example.com'),
(4, 'Nhà cung cấp D', '321 Đường PQR, Thành phố', '0101010101', 'nhacungcapd@example.com'),
(5, 'Nhà cung cấp E', '654 Đường STU, Thành phố', '0987654321', 'nhacungcape@example.com');

-- Thêm dữ liệu mẫu vào bảng SANPHAM (Sản phẩm)
INSERT INTO SANPHAM (MASP, MANCC, TENSP, GIA, MOTA)
VALUES 
(2, 2, 'Sản phẩm B', 150.00, 'Mô tả sản phẩm B'),
(3, 3, 'Sản phẩm C', 200.00, 'Mô tả sản phẩm C'),
(4, 4, 'Sản phẩm D', 250.00, 'Mô tả sản phẩm D'),
(5, 5, 'Sản phẩm E', 300.00, 'Mô tả sản phẩm E');

-- Thêm dữ liệu mẫu vào bảng KHO (Kho hàng)
INSERT INTO KHO (MAKHO, TENKHO, MASP)
VALUES 
(2, 'Kho B', 2),
(3, 'Kho C', 3),
(4, 'Kho D', 4),
(5, 'Kho E', 5);

-- Thêm dữ liệu mẫu vào bảng NHAPKHO (Nhập kho)
INSERT INTO NHAPKHO (MANHAPKHO, MAKHO, SOLUONG, NGAYNHAP)
VALUES 
(2, 2, 50, '2024-09-05'),
(3, 3, 75, '2024-09-10'),
(4, 4, 100, '2024-09-15'),
(5, 5, 150, '2024-09-20');

-- Thêm dữ liệu mẫu vào bảng TONKHO (Tồn kho)
INSERT INTO TONKHO (MATONKHO, MAKHO, SOLUONG)
VALUES 
(2, 2, 50),
(3, 3, 75),
(4, 4, 100),
(5, 5, 150);

-- Thêm dữ liệu mẫu vào bảng KHACHHANG (Khách hàng)
INSERT INTO KHACHHANG (MAKH, HOTEN, DIACHI, SODT, EMAIL)
VALUES 
(2, 'Khách hàng B', '987 Đường ABC, Thành phố', '0911223344', 'khachhangb@example.com'),
(3, 'Khách hàng C', '654 Đường DEF, Thành phố', '0922334455', 'khachhangc@example.com'),
(4, 'Khách hàng D', '321 Đường GHI, Thành phố', '0933445566', 'khachhangd@example.com'),
(5, 'Khách hàng E', '888 Đường JKL, Thành phố', '0944556677', 'khachhange@example.com');

-- Thêm dữ liệu mẫu vào bảng KHUYENMAI (Khuyến mãi)
INSERT INTO KHUYENMAI (MAKHUYENMAI, TENKHUYENMAI, PHANTRAMGIAMGIA, NGAYBATDAU, NGAYKETTHUC, MOTA)
VALUES 
('KM002', 'Giảm giá 20%', 20.00, '2024-09-05', '2024-09-15', 'Giảm 20% cho đơn hàng trên 200k'),
('KM003', 'Mua 2 tặng 1', 0.00, '2024-09-10', '2024-09-20', 'Mua 2 sản phẩm tặng 1 sản phẩm'),
('KM004', 'Miễn phí vận chuyển', 0.00, '2024-09-01', '2024-09-30', 'Miễn phí vận chuyển cho đơn hàng trên 500k'),
('KM005', 'Giảm giá 5%', 5.00, '2024-09-15', '2024-09-25', 'Giảm 5% cho khách hàng mới');

-- Thêm dữ liệu mẫu vào bảng DONHANG (Đơn hàng)
INSERT INTO DONHANG (MADH, MAKH, NGAYDATHANG, TONGTIEN, MAKHUYENMAI)
VALUES 
(2, 2, '2024-09-03', 135.00, 'KM002'),
(3, 3, '2024-09-06', 180.00, 'KM003'),
(4, 4, '2024-09-09', 280.00, 'KM004'),
(5, 5, '2024-09-12', 475.00, 'KM005');

-- Thêm dữ liệu mẫu vào bảng CHITIETDONHANG (Chi tiết đơn hàng)
INSERT INTO CHITIETDONHANG (MACT, MADH, MASP, MAKHUYENMAI, SOLUONG, GIA)
VALUES 
(2, 2, 2, 'KM002', 2, 135.00),
(3, 3, 3, 'KM003', 3, 180.00),
(4, 4, 4, 'KM004', 4, 280.00),
(5, 5, 5, 'KM005', 5, 475.00);

-- Thêm dữ liệu mẫu vào bảng NHANVIEN (Nhân viên)
INSERT INTO NHANVIEN (MANV, HOTEN, CHUCVU, NGAYVAOLAM, SODT, EMAIL)
VALUES 
(2, 'Nhân viên B', 'Nhân viên Kinh doanh', '2024-07-15', '0912456789', 'nhanvienb@example.com'),
(3, 'Nhân viên C', 'Nhân viên Kỹ thuật', '2024-08-05', '0912567890', 'nhanvienc@example.com'),
(4, 'Nhân viên D', 'Nhân viên Hành chính', '2024-06-20', '0912678901', 'nhanviend@example.com'),
(5, 'Nhân viên E', 'Nhân viên Marketing', '2024-09-01', '0912789012', 'nhanviene@example.com');

SELECT 
    MADH, 
    SUM(SOLUONG * GIA) AS THANHTIEN
FROM 
    CHITIETDONHANG
GROUP BY 
    MADH;

UPDATE DONHANG
SET TONGTIEN = (
    SELECT SUM(SOLUONG * GIA * (1 - (COALESCE(KHUYENMAI.PHANTRAMGIAMGIA, 0) / 100))) 
    FROM CHITIETDONHANG 
    LEFT JOIN KHUYENMAI ON CHITIETDONHANG.MAKHUYENMAI = KHUYENMAI.MAKHUYENMAI
    WHERE DONHANG.MADH = CHITIETDONHANG.MADH
);
<<<<<<< HEAD
DECLARE @MADH INT = 2;

UPDATE TONKHO
SET SOLUONG = SOLUONG - (
    SELECT SUM(SOLUONG)
    FROM CHITIETDONHANG
    WHERE CHITIETDONHANG.MASP = (SELECT MASP FROM KHO WHERE KHO.MAKHO = TONKHO.MAKHO)
    AND CHITIETDONHANG.MADH = @MADH
)
WHERE MAKHO = (SELECT MAKHO FROM KHO WHERE KHO.MASP = (SELECT MASP FROM CHITIETDONHANG WHERE MADH = @MADH));
=======
DECLARE @MADH INT = 2;

UPDATE TONKHO
SET SOLUONG = SOLUONG - (
    SELECT SUM(SOLUONG)
    FROM CHITIETDONHANG
    WHERE CHITIETDONHANG.MASP = (SELECT MASP FROM KHO WHERE KHO.MAKHO = TONKHO.MAKHO)
    AND CHITIETDONHANG.MADH = @MADH
)
WHERE MAKHO = (SELECT MAKHO FROM KHO WHERE KHO.MASP = (SELECT MASP FROM CHITIETDONHANG WHERE MADH = @MADH));
>>>>>>> 4c5f156a28f6b8c28f30e05ca0ab47dbdafffabc
